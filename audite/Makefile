# Makefile para AuditE - Ambiente de Desarrollo
# =============================================

.PHONY: help setup setup-sqlite setup-postgres start-db stop-db migrate install dev test clean logs docker-full docker-stop docker-logs docker-build

# Variables
PYTHON = python3
VENV = venv
DOCKER_COMPOSE = docker-compose -f docker-compose.dev.yml
DOCKER_COMPOSE_FULL = docker-compose -f docker-compose.full.yml

# Mostrar ayuda por defecto
help:
	@echo "ğŸš€ AuditE - Comandos de Desarrollo"
	@echo "=================================="
	@echo ""
	@echo "ğŸ“‹ ConfiguraciÃ³n inicial:"
	@echo "  setup            - Configurador interactivo"
	@echo "  setup-sqlite     - Configurar con SQLite"
	@echo "  setup-postgres   - Configurar con PostgreSQL"
	@echo ""
	@echo "ğŸ³ Docker Compose Completo:"
	@echo "  docker-full      - Levantar stack completo (Backend + Frontend + DB)"
	@echo "  docker-stop      - Detener stack completo"
	@echo "  docker-build     - Construir imÃ¡genes Docker"
	@echo "  docker-logs      - Ver logs del stack completo"
	@echo "  docker-clean     - Limpiar contenedores e imÃ¡genes"
	@echo ""
	@echo "ğŸ—„ï¸  Base de datos:"
	@echo "  start-db         - Iniciar PostgreSQL (Docker)"
	@echo "  stop-db          - Detener PostgreSQL"
	@echo "  migrate          - Ejecutar migraciones"
	@echo "  reset-db         - Resetear base de datos"
	@echo ""
	@echo "ğŸ”§ Desarrollo:"
	@echo "  install          - Instalar dependencias"
	@echo "  dev              - Iniciar servidor de desarrollo"
	@echo "  test             - Ejecutar tests"
	@echo "  logs             - Ver logs de PostgreSQL"
	@echo ""
	@echo "ğŸ§¹ Limpieza:"
	@echo "  clean            - Limpiar archivos temporales"
	@echo "  clean-all        - Limpiar todo (incluye Docker)"

# ========================================
# COMANDOS DOCKER COMPOSE COMPLETO
# ========================================

# Levantar stack completo (Backend + Frontend + PostgreSQL)
docker-full:
	@echo "ğŸš€ Levantando stack completo de AuditE..."
	@echo "ğŸ“¦ Esto incluye: PostgreSQL + Backend FastAPI + Frontend React + Adminer"
	@echo ""
	$(DOCKER_COMPOSE_FULL) up --build
	@echo ""
	@echo "âœ… Stack completo iniciado!"
	@echo "ğŸŒ URLs disponibles:"
	@echo "   Frontend:     http://localhost:8080"
	@echo "   Backend API:  http://localhost:8000"
	@echo "   API Docs:     http://localhost:8000/docs"
	@echo "   Adminer:      http://localhost:8081"
	@echo ""
	@echo "ğŸ” Credenciales Admin:"
	@echo "   Usuario: admin_audite"
	@echo "   Password: AuditE2024!SecureAdmin#2024"

# Levantar stack completo en background
docker-full-bg:
	@echo "ğŸš€ Levantando stack completo en background..."
	$(DOCKER_COMPOSE_FULL) up -d --build
	@echo "âœ… Stack iniciado en background"
	@$(MAKE) docker-status

# Detener stack completo
docker-stop:
	@echo "ğŸ›‘ Deteniendo stack completo..."
	$(DOCKER_COMPOSE_FULL) down
	@echo "âœ… Stack detenido"

# Construir imÃ¡genes Docker
docker-build:
	@echo "ğŸ”¨ Construyendo imÃ¡genes Docker..."
	$(DOCKER_COMPOSE_FULL) build --no-cache
	@echo "âœ… ImÃ¡genes construidas"

# Ver logs del stack completo
docker-logs:
	@echo "ğŸ“‹ Logs del stack completo:"
	$(DOCKER_COMPOSE_FULL) logs -f

# Ver logs de un servicio especÃ­fico
docker-logs-backend:
	@echo "ğŸ“‹ Logs del Backend:"
	$(DOCKER_COMPOSE_FULL) logs -f backend

docker-logs-frontend:
	@echo "ğŸ“‹ Logs del Frontend:"
	$(DOCKER_COMPOSE_FULL) logs -f frontend

docker-logs-db:
	@echo "ğŸ“‹ Logs de PostgreSQL:"
	$(DOCKER_COMPOSE_FULL) logs -f db

# Estado de los contenedores
docker-status:
	@echo "ğŸ“Š Estado de los contenedores:"
	$(DOCKER_COMPOSE_FULL) ps
	@echo ""
	@echo "ğŸŒ URLs disponibles:"
	@echo "   Frontend:     http://localhost:8080"
	@echo "   Backend API:  http://localhost:8000"
	@echo "   API Docs:     http://localhost:8000/docs"
	@echo "   Adminer:      http://localhost:8081"

# Reiniciar un servicio especÃ­fico
docker-restart-backend:
	@echo "ğŸ”„ Reiniciando Backend..."
	$(DOCKER_COMPOSE_FULL) restart backend

docker-restart-frontend:
	@echo "ğŸ”„ Reiniciando Frontend..."
	$(DOCKER_COMPOSE_FULL) restart frontend

# Limpiar contenedores e imÃ¡genes Docker
docker-clean:
	@echo "ğŸ§¹ Limpiando contenedores e imÃ¡genes Docker..."
	$(DOCKER_COMPOSE_FULL) down -v --remove-orphans
	@docker image prune -f
	@docker container prune -f
	@echo "âœ… Limpieza Docker completada"

# ========================================
# COMANDOS ORIGINALES (sin cambios)
# ========================================

# ConfiguraciÃ³n interactiva
setup:
	@echo "ğŸš€ Iniciando configurador..."
	$(PYTHON) scripts/setup_dev.py

# ConfiguraciÃ³n con SQLite
setup-sqlite:
	@echo "ğŸ—„ï¸  Configurando con SQLite..."
	@if [ ! -f .env ]; then \
		echo "âŒ Archivo .env no encontrado"; \
		exit 1; \
	fi
	@$(MAKE) install
	@$(MAKE) migrate
	@echo "âœ… ConfiguraciÃ³n SQLite completada"

# ConfiguraciÃ³n con PostgreSQL
setup-postgres:
	@echo "ğŸ˜ Configurando con PostgreSQL..."
	@if [ ! -f .env.dev ]; then \
		echo "âŒ Archivo .env.dev no encontrado"; \
		exit 1; \
	fi
	@cp .env.dev .env
	@$(MAKE) start-db
	@sleep 5
	@$(MAKE) install
	@$(MAKE) migrate
	@echo "âœ… ConfiguraciÃ³n PostgreSQL completada"

# Iniciar base de datos PostgreSQL
start-db:
	@echo "ğŸ³ Iniciando PostgreSQL..."
	$(DOCKER_COMPOSE) up -d db adminer
	@echo "âœ… PostgreSQL iniciado en puerto 5432"
	@echo "ğŸŒ Adminer disponible en http://localhost:8081"

# Detener base de datos
stop-db:
	@echo "ğŸ›‘ Deteniendo PostgreSQL..."
	$(DOCKER_COMPOSE) down
	@echo "âœ… PostgreSQL detenido"

# Ejecutar migraciones
migrate:
	@echo "ğŸ”„ Ejecutando migraciones..."
	@if [ -d $(VENV) ]; then \
		$(VENV)/bin/alembic upgrade head; \
	else \
		alembic upgrade head; \
	fi
	@echo "âœ… Migraciones aplicadas"

# Resetear base de datos
reset-db:
	@echo "âš ï¸  Reseteando base de datos..."
	@read -p "Â¿EstÃ¡s seguro? Esto borrarÃ¡ todos los datos (y/N): " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		if [ -f audite.db ]; then \
			rm audite.db; \
			echo "ğŸ—‘ï¸  SQLite eliminada"; \
		fi; \
		$(DOCKER_COMPOSE) down -v; \
		$(DOCKER_COMPOSE) up -d db; \
		sleep 5; \
		$(MAKE) migrate; \
		echo "âœ… Base de datos reseteada"; \
	else \
		echo "âŒ OperaciÃ³n cancelada"; \
	fi

# Instalar dependencias
install:
	@echo "ğŸ“¦ Instalando dependencias..."
	@if [ ! -d $(VENV) ]; then \
		$(PYTHON) -m venv $(VENV); \
		echo "ğŸ”§ Entorno virtual creado"; \
	fi
	@$(VENV)/bin/pip install -r requirements.txt
	@echo "âœ… Dependencias instaladas"

# Iniciar servidor de desarrollo
dev:
	@echo "ğŸš€ Iniciando servidor de desarrollo..."
	@if [ -d $(VENV) ]; then \
		$(VENV)/bin/python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000; \
	else \
		echo "âŒ Entorno virtual no encontrado. Ejecuta 'make install' primero"; \
	fi

# Ejecutar tests
test:
	@echo "ğŸ§ª Ejecutando tests..."
	@if [ -d $(VENV) ]; then \
		$(VENV)/bin/python -m pytest tests/ -v; \
	else \
		echo "âŒ Entorno virtual no encontrado. Ejecuta 'make install' primero"; \
	fi

# Ver logs de PostgreSQL
logs:
	@echo "ğŸ“‹ Logs de PostgreSQL:"
	$(DOCKER_COMPOSE) logs -f db

# Limpiar archivos temporales
clean:
	@echo "ğŸ§¹ Limpiando archivos temporales..."
	@find . -name "*.pyc" -delete
	@find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@find . -name "*.log" -delete 2>/dev/null || true
	@echo "âœ… Limpieza completada"

# Limpieza completa
clean-all: clean
	@echo "ğŸ§¹ Limpieza completa..."
	@$(DOCKER_COMPOSE) down -v --remove-orphans 2>/dev/null || true
	@docker system prune -f 2>/dev/null || true
	@rm -rf $(VENV) 2>/dev/null || true
	@echo "âœ… Limpieza completa terminada"

# Verificar estado del sistema
status:
	@echo "ğŸ“Š Estado del sistema:"
	@echo ""
	@echo "ğŸ”§ Entorno virtual:"
	@if [ -d $(VENV) ]; then \
		echo "  âœ… Creado"; \
	else \
		echo "  âŒ No creado"; \
	fi
	@echo ""
	@echo "ğŸ—„ï¸  Base de datos:"
	@if [ -f audite.db ]; then \
		echo "  âœ… SQLite encontrada"; \
	fi
	@if docker ps | grep -q audite_postgres_dev; then \
		echo "  âœ… PostgreSQL corriendo"; \
	else \
		echo "  âŒ PostgreSQL no estÃ¡ corriendo"; \
	fi
	@echo ""
	@echo "âš™ï¸  ConfiguraciÃ³n:"
	@if [ -f .env ]; then \
		echo "  âœ… .env encontrado"; \
		grep "^DATABASE_URL" .env | head -1; \
	else \
		echo "  âŒ .env no encontrado"; \
	fi 